<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‚…é‡Œå¶çº§æ•°å¯è§†åŒ–</title>
    <style>
        /* æ ·å¼ä»£ç ä¸åŸå§‹æ–‡æ¡£å®Œå…¨ç›¸åŒ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            color: #212529;
            line-height: 1.6;
            font-size: 18px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.08);
            padding: 50px;
            max-width: 1400px;
            width: 100%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        h1 {
            text-align: center;
            color: #2b2d42;
            margin-bottom: 15px;
            font-size: 3.5em;
            font-weight: 600;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .subtitle {
            text-align: center;
            color: #495057;
            margin-bottom: 50px;
            font-size: 1.5em;
            font-weight: 400;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 35px;
            margin-bottom: 50px;
            padding: 35px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .control-group {
            flex: 1;
            min-width: 250px;
        }

        .control-group label {
            display: block;
            margin-bottom: 15px;
            color: #2b2d42;
            font-weight: 600;
            font-size: 1.2em;
        }

        .signal-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .signal-btn {
            padding: 15px 25px;
            border: 2px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
            color: #495057;
            font-weight: 600;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.03);
        }

        .signal-btn:hover {
            background: #e9ecef;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.08);
        }

        .signal-btn.active {
            background: #4361ee;
            color: white;
            border-color: #4361ee;
            box-shadow: 0 6px 12px rgba(67, 97, 238, 0.25);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
            transition: all 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            background: #4361ee;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid white;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.3);
            background: #3a56d4;
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: 700;
            color: #4361ee;
            font-size: 1.3em;
        }

        .canvas-container {
            position: relative;
            background: #ffffff;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 35px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        canvas {
            border: 2px solid #f1f3f5;
            border-radius: 12px;
            display: block;
            margin: 0 auto;
            background: #fefefe;
            width: 100%;
            height: auto;
            max-width: 1200px;
        }

        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.7);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-8px);
        }

        .info-card h3 {
            color: #2b2d42;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .info-card p {
            color: #495057;
            font-size: 1.1em;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .formula {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 1em;
            color: #2b2d42;
            margin-top: 20px;
            border-left: 4px solid #4361ee;
            overflow-x: auto;
            white-space: pre-wrap;
            font-weight: 500;
        }

        .harmonic-info {
            background: #f1f3f5;
            padding: 15px 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 1em;
            color: #495057;
            border-left: 4px solid #4cc9f0;
        }

        .play-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 35px;
        }

        .control-btn {
            padding: 16px 32px;
            border: none;
            background: #4361ee;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            box-shadow: 0 5px 10px rgba(67, 97, 238, 0.25);
        }

        .control-btn:hover {
            background: #3a56d4;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(67, 97, 238, 0.3);
        }

        .control-btn.stop {
            background: #f72585;
            box-shadow: 0 5px 10px rgba(247, 37, 133, 0.25);
        }

        .control-btn.stop:hover {
            background: #e01a75;
            box-shadow: 0 8px 16px rgba(247, 37, 133, 0.3);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4361ee, #4cc9f0);
            width: 0%;
            transition: width 0.3s ease;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 35px;
            margin-top: 25px;
            flex-wrap: wrap;
            font-size: 1.1em;
            font-weight: 500;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px 16px;
            border-radius: 30px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .legend-color {
            width: 24px;
            height: 4px;
            border-radius: 2px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 30px;
            }
            
            h1 {
                font-size: 2.5em;
            }
            
            .subtitle {
                font-size: 1.2em;
            }
            
            .controls {
                flex-direction: column;
                gap: 25px;
            }
            
            .info-panel {
                grid-template-columns: 1fr;
            }
            
            .signal-buttons {
                justify-content: center;
            }
            
            .legend {
                gap: 15px;
            }
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container fade-in">
        <h1>å‚…é‡Œå¶çº§æ•°å¯è§†åŒ–</h1>
        <p class="subtitle">è§‚å¯Ÿå‘¨æœŸæ€§ä¿¡å·çš„è°æ³¢å åŠ è¿‡ç¨‹</p>

        <div class="controls">
            <div class="control-group">
                <label>é€‰æ‹©ä¿¡å·ç±»å‹</label>
                <div class="signal-buttons">
                    <button class="signal-btn active" data-signal="triangle">ä¸‰è§’æ³¢</button>
                    <button class="signal-btn" data-signal="square">æ–¹æ³¢</button>
                    <button class="signal-btn" data-signal="sawtooth">é”¯é½¿æ³¢</button>
                    <button class="signal-btn" data-signal="halfwave">åŠæ³¢æ•´æµ</button>
                    <button class="signal-btn" data-signal="fullwave">å…¨æ³¢æ•´æµ</button>
                </div>
            </div>

            <div class="control-group">
                <label>è°æ³¢æ¬¡æ•°: <span class="slider-value" id="harmonicValue">5</span></label>
                <div class="slider-container">
                    <input type="range" id="harmonicSlider" min="1" max="30" value="5">
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>

            <div class="control-group">
                <label>åŠ¨ç”»é€Ÿåº¦</label>
                <div class="slider-container">
                    <input type="range" id="speedSlider" min="1" max="10" value="5">
                    <span class="slider-value" id="speedValue">5</span>
                </div>
            </div>
        </div>

        <div class="play-controls">
            <button class="control-btn" id="playBtn">
                <span>â–¶</span> æ’­æ”¾åŠ¨ç”»
            </button>
            <button class="control-btn stop" id="pauseBtn">
                <span>â¸</span> æš‚åœ
            </button>
            <button class="control-btn" id="resetBtn">
                <span>âŸ²</span> é‡ç½®
            </button>
        </div>

        <div class="canvas-container">
            <canvas id="fourierCanvas" width="1200" height="600"></canvas>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #e74c3c;"></div>
                    <span>ç›®æ ‡ä¿¡å·</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4361ee;"></div>
                    <span>å‚…é‡Œå¶é€¼è¿‘</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4cc9f0;"></div>
                    <span>å½“å‰è°æ³¢</span>
                </div>
            </div>
        </div>

        <div class="info-panel">
            <div class="info-card fade-in">
                <h3>ğŸ“Š ä¿¡å·ä¿¡æ¯</h3>
                <p id="signalDescription">ä¸‰è§’æ³¢ï¼šå¥‡å¯¹ç§°ä¿¡å·ï¼Œåªå«å¥‡æ¬¡è°æ³¢</p>
                <div class="formula" id="signalFormula">
f(t) = (8/Ï€Â²) Ã— [sin(Ï‰t)/1Â² - sin(3Ï‰t)/3Â² + sin(5Ï‰t)/5Â² - ...]</div>
                <div class="harmonic-info" id="harmonicInfo">
                    å½“å‰æ˜¾ç¤º: 5 æ¬¡è°æ³¢ (3, 5, 7, 9, 11)
                </div>
            </div>

            <div class="info-card fade-in">
                <h3>ğŸ¯ å‚…é‡Œå¶çº§æ•°åŸç†</h3>
                <p>ä»»ä½•å‘¨æœŸæ€§ä¿¡å·éƒ½å¯ä»¥è¡¨ç¤ºä¸ºæ— ç©·å¤šä¸ªæ­£å¼¦å’Œä½™å¼¦å‡½æ•°çš„å åŠ ã€‚éšç€è°æ³¢æ¬¡æ•°çš„å¢åŠ ï¼Œé€¼è¿‘æ•ˆæœè¶Šæ¥è¶Šå¥½ã€‚</p>
                <div class="formula">
f(t) = aâ‚€ + Î£[aâ‚™cos(nÏ‰t) + bâ‚™sin(nÏ‰t)]</div>
            </div>

            <div class="info-card fade-in">
                <h3>ğŸ“ˆ è§‚å¯Ÿè¦ç‚¹</h3>
                <p>â€¢ å‰å¸ƒæ–¯ç°è±¡ï¼šåœ¨ä¸è¿ç»­ç‚¹é™„è¿‘ä¼šå‡ºç°è¿‡å†²</p>
                <p>â€¢ å¯¹ç§°æ€§å†³å®šè°æ³¢æˆåˆ†</p>
                <p>â€¢ è°æ³¢å¹…åº¦éšé¢‘ç‡å¢åŠ è€Œå‡å°</p>
                <p>â€¢ ç›¸ä½å…³ç³»å½±å“æ³¢å½¢å½¢çŠ¶</p>
            </div>

            <div class="info-card fade-in">
                <h3>ğŸ›ï¸ æ“ä½œè¯´æ˜</h3>
                <p>â€¢ é€‰æ‹©ä¸åŒä¿¡å·è§‚å¯Ÿå…¶é¢‘è°±ç‰¹æ€§</p>
                <p>â€¢ è°ƒæ•´è°æ³¢æ¬¡æ•°æŸ¥çœ‹é€¼è¿‘æ•ˆæœ</p>
                <p>â€¢ ä½¿ç”¨åŠ¨ç”»æ¨¡å¼è‡ªåŠ¨æ¼”ç¤ºå åŠ è¿‡ç¨‹</p>
                <p>â€¢ æ³¨æ„ä¸åŒä¿¡å·çš„å¯¹ç§°æ€§å’Œè°æ³¢æˆåˆ†</p>
            </div>
        </div>
    </div>

    <script>
        class FourierSeriesVisualizer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.width = this.canvas.width;
                this.height = this.canvas.height;
                
                // åŠ¨ç”»å‚æ•°
                this.currentHarmonic = 1;
                this.maxHarmonic = 5;
                this.animationSpeed = 5;
                this.isAnimating = false;
                this.animationId = null;
                this.animationProgress = 0;
                
                // ä¿¡å·å‚æ•°
                this.currentSignal = 'triangle';
                this.frequency = 1; // åŸºæ³¢é¢‘ç‡
                this.amplitude = 1; // å¹…åº¦
                
                // ç»˜å›¾å‚æ•°
                this.padding = 80;
                this.gridColor = '#e9ecef';
                this.axisColor = '#495057';
                this.targetColor = '#e74c3c';
                this.approxColor = '#4361ee';
                this.harmonicColor = '#4cc9f0';
                
                // åˆå§‹åŒ–
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.draw();
                this.updateInfo();
            }
            
            setupEventListeners() {
                // ä¿¡å·é€‰æ‹©æŒ‰é’®
                document.querySelectorAll('.signal-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelector('.signal-btn.active').classList.remove('active');
                        e.target.classList.add('active');
                        this.currentSignal = e.target.dataset.signal;
                        this.reset();
                        this.updateInfo();
                    });
                });
                
                // è°æ³¢æ¬¡æ•°æ»‘å—
                const harmonicSlider = document.getElementById('harmonicSlider');
                harmonicSlider.addEventListener('input', (e) => {
                    this.maxHarmonic = parseInt(e.target.value);
                    document.getElementById('harmonicValue').textContent = this.maxHarmonic;
                    this.updateProgress();
                    this.updateInfo();
                    if (!this.isAnimating) {
                        this.draw();
                    }
                });
                
                // é€Ÿåº¦æ»‘å—
                const speedSlider = document.getElementById('speedSlider');
                speedSlider.addEventListener('input', (e) => {
                    this.animationSpeed = parseInt(e.target.value);
                    document.getElementById('speedValue').textContent = this.animationSpeed;
                });
                
                // æ’­æ”¾æ§åˆ¶æŒ‰é’®
                document.getElementById('playBtn').addEventListener('click', () => this.startAnimation());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pauseAnimation());
                document.getElementById('resetBtn').addEventListener('click', () => this.reset());
                
                // çª—å£å¤§å°æ”¹å˜
                window.addEventListener('resize', () => this.handleResize());
            }
            
            handleResize() {
                // å“åº”å¼è°ƒæ•´
                const container = this.canvas.parentElement;
                const maxWidth = container.clientWidth - 80;
                if (maxWidth < this.width) {
                    const scale = maxWidth / this.width;
                    this.canvas.style.width = maxWidth + 'px';
                    this.canvas.style.height = (this.height * scale) + 'px';
                } else {
                    this.canvas.style.width = this.width + 'px';
                    this.canvas.style.height = this.height + 'px';
                }
            }
            
            // è·å–ä¿¡å·ä¿¡æ¯
            getSignalInfo(signal) {
                const info = {
                    triangle: {
                        description: 'ä¸‰è§’æ³¢ï¼šå¥‡å¯¹ç§°ä¿¡å·ï¼Œåªå«å¥‡æ¬¡è°æ³¢',
                        formula: 'f(t) = (8/Ï€Â²) Ã— [sin(Ï‰t)/1Â² - sin(3Ï‰t)/3Â² + sin(5Ï‰t)/5Â² - ...]',
                        harmonics: 'å¥‡æ¬¡è°æ³¢ (1, 3, 5, 7, ...)',
                        symmetry: 'å¥‡å¯¹ç§°'
                    },
                    square: {
                        description: 'æ–¹æ³¢ï¼šå¥‡å¯¹ç§°ä¿¡å·ï¼Œåªå«å¥‡æ¬¡æ­£å¼¦è°æ³¢',
                        formula: 'f(t) = (4/Ï€) Ã— [sin(Ï‰t)/1 + sin(3Ï‰t)/3 + sin(5Ï‰t)/5 + ...]',
                        harmonics: 'å¥‡æ¬¡è°æ³¢ (1, 3, 5, 7, ...)',
                        symmetry: 'å¥‡å¯¹ç§°'
                    },
                    sawtooth: {
                        description: 'é”¯é½¿æ³¢ï¼šå¥‡å¶æ¬¡è°æ³¢éƒ½æœ‰ï¼Œå¹…åº¦é€’å‡',
                        formula: 'f(t) = (2/Ï€) Ã— [sin(Ï‰t)/1 - sin(2Ï‰t)/2 + sin(3Ï‰t)/3 - ...]',
                        harmonics: 'æ‰€æœ‰è°æ³¢ (1, 2, 3, 4, ...)',
                        symmetry: 'åŠæ³¢å¯¹ç§°'
                    },
                    halfwave: {
                        description: 'åŠæ³¢æ•´æµï¼šå¶å¯¹ç§°ï¼Œå«ç›´æµå’Œå¶æ¬¡è°æ³¢',
                        formula: 'f(t) = (1/Ï€) + (1/2)sin(Ï‰t) - (2/Ï€)Ã—[cos(2Ï‰t)/(1Ã—3) + cos(4Ï‰t)/(3Ã—5) + ...]',
                        harmonics: 'å¶æ¬¡è°æ³¢ (0, 1, 2, 4, 6, ...)',
                        symmetry: 'å¶å¯¹ç§°'
                    },
                    fullwave: {
                        description: 'å…¨æ³¢æ•´æµï¼šå¶å¯¹ç§°ï¼Œå«ç›´æµå’Œå¶æ¬¡è°æ³¢',
                        formula: 'f(t) = (2/Ï€) - (4/Ï€)Ã—[cos(2Ï‰t)/(1Ã—3) + cos(4Ï‰t)/(3Ã—5) + cos(6Ï‰t)/(5Ã—7) + ...]',
                        harmonics: 'å¶æ¬¡è°æ³¢ (0, 2, 4, 6, ...)',
                        symmetry: 'å¶å¯¹ç§°'
                    }
                };
                return info[signal] || info.triangle;
            }
            
            // è®¡ç®—å‚…é‡Œå¶çº§æ•° - åªä¿®æ”¹é”¯é½¿æ³¢éƒ¨åˆ†
            calculateFourierSeries(t, maxHarmonic) {
                let sum = 0;
                const omega = 2 * Math.PI * this.frequency;
                
                switch (this.currentSignal) {
                    case 'triangle':
                        // ä¸‰è§’æ³¢ï¼šä»…å¥‡æ¬¡è°æ³¢ï¼Œæ­£å¼¦é¡¹ï¼Œç›¸ä½ä¿®æ­£ï¼ˆä¿æŒåŸå§‹ï¼‰
                        for (let n = 1; n <= maxHarmonic; n += 2) {
                            const coefficient = 8 / (Math.PI * Math.PI * n * n);
                            sum += coefficient * Math.sin(n * omega * t + Math.PI/2 * (n-1)) * Math.pow(-1, (n - 1) / 2);
                        }
                        return sum * this.amplitude;
                        
                    case 'square':
                        // æ–¹æ³¢ï¼šä»…å¥‡æ¬¡è°æ³¢ï¼Œæ­£å¼¦é¡¹ï¼ˆä¿æŒåŸå§‹ï¼‰
                        for (let n = 1; n <= maxHarmonic; n += 2) {
                            const coefficient = 4 / (Math.PI * n);
                            sum += coefficient * Math.sin(n * omega * t);
                        }
                        return sum * this.amplitude;
                        
                    case 'sawtooth':
                        // âœ… åªä¿®æ”¹è¿™é‡Œï¼šç§»é™¤é”™è¯¯çš„ + Math.PI ç›¸ä½åç§»
                        // æ ‡å‡†å…¬å¼ï¼šf(t) = (2/Ï€) Ã— [sin(Ï‰t)/1 - sin(2Ï‰t)/2 + sin(3Ï‰t)/3 - ...]
                        for (let n = 1; n <= maxHarmonic; n++) {
                            const coefficient = 2 / (Math.PI * n);
                            sum += coefficient * Math.sin(n * omega * t) * Math.pow(-1, n + 1);
                        }
                        return sum * this.amplitude;
                        
                    case 'halfwave':
                        // åŠæ³¢æ•´æµï¼šç›´æµåˆ†é‡ + åŸºæ³¢ + å¶æ¬¡è°æ³¢ï¼ˆä¿æŒåŸå§‹ï¼‰
                        sum += 1 / Math.PI;
                        if (maxHarmonic >= 1) {
                            sum += 0.5 * Math.sin(omega * t);
                        }
                        for (let n = 2; n <= maxHarmonic; n += 2) {
                            const coefficient = -2 / (Math.PI * (n * n - 1));
                            sum += coefficient * Math.cos(n * omega * t);
                        }
                        return sum * this.amplitude;
                        
                    case 'fullwave':
                        // å…¨æ³¢æ•´æµï¼šç›´æµåˆ†é‡ + å¶æ¬¡è°æ³¢ï¼ˆä¿æŒåŸå§‹ï¼‰
                        sum += 2 / Math.PI;
                        for (let n = 2; n <= maxHarmonic; n += 2) {
                            const coefficient = -4 / (Math.PI * (n * n - 1));
                            sum += coefficient * Math.cos(n * omega * t);
                        }
                        return sum * this.amplitude;
                        
                    default:
                        return 0;
                }
            }
            
            // è·å–ç›®æ ‡ä¿¡å· - åªä¿®æ”¹é”¯é½¿æ³¢éƒ¨åˆ†
            getTargetSignal(t) {
                const period = 1 / this.frequency;
                // ä¿æŒåŸå§‹å‘¨æœŸå¤„ç†æ–¹å¼ä¸å˜
                const t_norm = ((t % period) + period) % period; // å½’ä¸€åŒ–åˆ°[0, period]
                
                switch (this.currentSignal) {
                    case 'triangle':
                        // ä¿æŒåŸå§‹ä¸‰è§’æ³¢å®šä¹‰
                        if (t_norm < period / 4) {
                            return (4 * this.amplitude / period) * t_norm;
                        } else if (t_norm < 3 * period / 4) {
                            return (-4 * this.amplitude / period) * t_norm + 2 * this.amplitude;
                        } else {
                            return (4 * this.amplitude / period) * t_norm - 4 * this.amplitude;
                        }
                        
                    case 'square':
                        // ä¿æŒåŸå§‹æ–¹æ³¢å®šä¹‰
                        return t_norm < period / 2 ? this.amplitude : -this.amplitude;
                        
                    case 'sawtooth':
                        // âœ… åªä¿®æ”¹è¿™é‡Œï¼šä½¿ç”¨ä¸å‚…é‡Œå¶çº§æ•°åŒ¹é…çš„é”¯é½¿æ³¢å®šä¹‰
                        // ä» -1 åˆ° 1 çº¿æ€§å˜åŒ–ï¼Œä¸å‚…é‡Œå¶çº§æ•°ç›¸ä½ä¸€è‡´
                        return (2 * this.amplitude / period) * t_norm - this.amplitude;
                        
                    case 'halfwave':
                        // ä¿æŒåŸå§‹åŠæ³¢æ•´æµå®šä¹‰
                        const halfwave_sin = Math.sin(2 * Math.PI * t * this.frequency);
                        return halfwave_sin > 0 ? halfwave_sin * this.amplitude : 0;
                        
                    case 'fullwave':
                        // ä¿æŒåŸå§‹å…¨æ³¢æ•´æµå®šä¹‰
                        return Math.abs(Math.sin(2 * Math.PI * t * this.frequency)) * this.amplitude;
                        
                    default:
                        return 0;
                }
            }
            
            // ç»˜åˆ¶ç½‘æ ¼
            drawGrid() {
                const ctx = this.ctx;
                ctx.strokeStyle = this.gridColor;
                ctx.lineWidth = 2;
                
                // å‚ç›´ç½‘æ ¼çº¿
                for (let x = this.padding; x <= this.width - this.padding; x += 60) {
                    ctx.beginPath();
                    ctx.moveTo(x, this.padding);
                    ctx.lineTo(x, this.height - this.padding);
                    ctx.stroke();
                }
                
                // æ°´å¹³ç½‘æ ¼çº¿
                for (let y = this.padding; y <= this.height - this.padding; y += 60) {
                    ctx.beginPath();
                    ctx.moveTo(this.padding, y);
                    ctx.lineTo(this.width - this.padding, y);
                    ctx.stroke();
                }
                
                // åæ ‡è½´
                ctx.strokeStyle = this.axisColor;
                ctx.lineWidth = 4;
                
                // Xè½´
                ctx.beginPath();
                ctx.moveTo(this.padding, this.height / 2);
                ctx.lineTo(this.width - this.padding, this.height / 2);
                ctx.stroke();
                
                // Yè½´
                ctx.beginPath();
                ctx.moveTo(this.padding, this.padding);
                ctx.lineTo(this.padding, this.height - this.padding);
                ctx.stroke();
                
                // åæ ‡è½´æ ‡ç­¾
                ctx.fillStyle = this.axisColor;
                ctx.font = 'bold 16px Segoe UI, Helvetica Neue, sans-serif';
                ctx.textAlign = 'center';
                
                // Xè½´æ ‡ç­¾
                for (let x = this.padding; x <= this.width - this.padding; x += 60) {
                    const t = this.xToTime(x);
                    ctx.fillText(t.toFixed(1), x, this.height / 2 + 30);
                }
                
                // Yè½´æ ‡ç­¾
                ctx.textAlign = 'right';
                for (let y = this.padding; y <= this.height - this.padding; y += 60) {
                    const amplitude = this.yToAmplitude(y);
                    ctx.fillText(amplitude.toFixed(1), this.padding - 15, y + 6);
                }
                
                // è½´æ ‡é¢˜
                ctx.textAlign = 'center';
                ctx.font = 'bold 18px Segoe UI, Helvetica Neue, sans-serif';
                ctx.fillText('æ—¶é—´ (s)', this.width / 2, this.height - 10);
                
                ctx.save();
                ctx.translate(30, this.height / 2);
                ctx.rotate(-Math.PI / 2);
                ctx.fillText('å¹…åº¦', 0, 0);
                ctx.restore();
            }
            
            // åæ ‡è½¬æ¢
            xToTime(x) {
                const totalTime = 3 / this.frequency; // æ˜¾ç¤º3ä¸ªå‘¨æœŸ
                return (x - this.padding) / (this.width - 2 * this.padding) * totalTime;
            }
            
            timeToX(t) {
                const totalTime = 3 / this.frequency;
                return this.padding + (t / totalTime) * (this.width - 2 * this.padding);
            }
            
            amplitudeToY(amplitude) {
                const scale = (this.height - 2 * this.padding) / 2;
                return this.height / 2 - amplitude * scale;
            }
            
            yToAmplitude(y) {
                const scale = (this.height - 2 * this.padding) / 2;
                return (this.height / 2 - y) / scale;
            }
            
            // ç»˜åˆ¶æ›²çº¿
            drawCurve(color, lineWidth, getValue, maxHarmonic = null) {
                const ctx = this.ctx;
                ctx.strokeStyle = color;
                ctx.lineWidth = lineWidth;
                ctx.beginPath();
                
                let firstPoint = true;
                const step = 0.01 / this.frequency;
                
                for (let t = 0; t <= 3 / this.frequency; t += step) {
                    const x = this.timeToX(t);
                    let y;
                    
                    if (maxHarmonic !== null) {
                        y = this.amplitudeToY(this.calculateFourierSeries(t, maxHarmonic));
                    } else {
                        y = this.amplitudeToY(getValue(t));
                    }
                    
                    if (firstPoint) {
                        ctx.moveTo(x, y);
                        firstPoint = false;
                    } else {
                        if (x >= this.padding && x <= this.width - this.padding) {
                            ctx.lineTo(x, y);
                        }
                    }
                }
                
                ctx.stroke();
            }
            
            // ç»˜åˆ¶åŠ¨ç”»æ•ˆæœ
            drawAnimation() {
                const ctx = this.ctx;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, this.width, this.height);
                
                // ç»˜åˆ¶ç½‘æ ¼
                this.drawGrid();
                
                // ç»˜åˆ¶ç›®æ ‡ä¿¡å·
                this.drawCurve(this.targetColor, 8, (t) => this.getTargetSignal(t));
                
                // ç»˜åˆ¶å½“å‰è°æ³¢
                if (this.currentHarmonic >= 1) {
                    this.drawCurve(this.harmonicColor, 4, null, this.currentHarmonic);
                }
                
                // ç»˜åˆ¶é€¼è¿‘ä¿¡å·
                if (this.currentHarmonic > 1) {
                    this.drawCurve(this.approxColor, 6, null, this.currentHarmonic - 1);
                }
                
                // æ·»åŠ å›¾ä¾‹
                this.drawLegend();
                
                // ç»˜åˆ¶è°æ³¢ä¿¡æ¯
                this.drawHarmonicInfo();
            }
            
            // ç»˜åˆ¶å›¾ä¾‹
            drawLegend() {
                const ctx = this.ctx;
                const legendX = this.width - 250;
                const legendY = this.padding + 30;
                
                ctx.font = 'bold 14px Segoe UI, Helvetica Neue, sans-serif';
                
                // ç›®æ ‡ä¿¡å·
                ctx.strokeStyle = this.targetColor;
                ctx.lineWidth = 8;
                ctx.beginPath();
                ctx.moveTo(legendX, legendY);
                ctx.lineTo(legendX + 30, legendY);
                ctx.stroke();
                ctx.fillStyle = '#212529';
                ctx.textAlign = 'left';
                ctx.fillText('ç›®æ ‡ä¿¡å·', legendX + 35, legendY + 6);
                
                // é€¼è¿‘ä¿¡å·
                ctx.strokeStyle = this.approxColor;
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(legendX, legendY + 30);
                ctx.lineTo(legendX + 30, legendY + 30);
                ctx.stroke();
                ctx.fillText('å‚…é‡Œå¶é€¼è¿‘', legendX + 35, legendY + 36);
                
                // å½“å‰è°æ³¢
                ctx.strokeStyle = this.harmonicColor;
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(legendX, legendY + 60);
                ctx.lineTo(legendX + 30, legendY + 60);
                ctx.stroke();
                ctx.fillText('å½“å‰è°æ³¢', legendX + 35, legendY + 66);
            }
            
            // ç»˜åˆ¶è°æ³¢ä¿¡æ¯
            drawHarmonicInfo() {
                const ctx = this.ctx;
                const infoX = this.padding + 30;
                const infoY = this.height - this.padding - 40;
                
                ctx.fillStyle = '#212529';
                ctx.font = 'bold 16px Segoe UI, Helvetica Neue, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(`è°æ³¢æ¬¡æ•°: ${this.currentHarmonic}`, infoX, infoY);
                
                if (this.currentHarmonic >= 1) {
                    const harmonics = this.getActiveHarmonics(this.currentHarmonic);
                    ctx.fillText(`æ´»è·ƒè°æ³¢: ${harmonics}`, infoX, infoY + 20);
                }
            }
            
            // è·å–æ´»è·ƒè°æ³¢
            getActiveHarmonics(n) {
                const harmonics = [];
                switch (this.currentSignal) {
                    case 'triangle':
                    case 'square':
                        for (let i = 1; i <= n; i += 2) {
                            harmonics.push(i);
                        }
                        break;
                    case 'sawtooth':
                        for (let i = 1; i <= n; i++) {
                            harmonics.push(i);
                        }
                        break;
                    case 'halfwave':
                        harmonics.push(0); // ç›´æµ
                        if (n >= 1) harmonics.push(1); // åŸºæ³¢
                        for (let i = 2; i <= n; i += 2) {
                            harmonics.push(i);
                        }
                        break;
                    case 'fullwave':
                        harmonics.push(0); // ç›´æµ
                        for (let i = 2; i <= n; i += 2) {
                            harmonics.push(i);
                        }
                        break;
                }
                return harmonics.slice(0, 5).join(', ') + (harmonics.length > 5 ? '...' : '');
            }
            
            // æ­£å¸¸ç»˜åˆ¶
            draw() {
                const ctx = this.ctx;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, this.width, this.height);
                
                // ç»˜åˆ¶ç½‘æ ¼
                this.drawGrid();
                
                // ç»˜åˆ¶ç›®æ ‡ä¿¡å·
                this.drawCurve(this.targetColor, 8, (t) => this.getTargetSignal(t));
                
                // ç»˜åˆ¶å‚…é‡Œå¶é€¼è¿‘
                this.drawCurve(this.approxColor, 6, null, this.maxHarmonic);
                
                // æ·»åŠ å›¾ä¾‹
                this.drawLegend();
                
                // æ›´æ–°è¿›åº¦æ¡
                this.updateProgress();
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            updateProgress() {
                const progress = (this.currentHarmonic / this.maxHarmonic) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
            }
            
            // æ›´æ–°ä¿¡æ¯é¢æ¿
            updateInfo() {
                const info = this.getSignalInfo(this.currentSignal);
                document.getElementById('signalDescription').textContent = info.description;
                document.getElementById('signalFormula').textContent = info.formula;
                this.updateHarmonicInfo();
            }
            
            // æ›´æ–°è°æ³¢ä¿¡æ¯
            updateHarmonicInfo() {
                const harmonics = this.getActiveHarmonics(this.maxHarmonic);
                document.getElementById('harmonicInfo').textContent = `å½“å‰æ˜¾ç¤º: ${this.maxHarmonic} æ¬¡è°æ³¢ (${harmonics})`;
            }
            
            // å¼€å§‹åŠ¨ç”»
            startAnimation() {
                if (this.isAnimating) return;
                
                this.isAnimating = true;
                this.currentHarmonic = 1;
                
                const animate = () => {
                    if (!this.isAnimating) return;
                    
                    this.drawAnimation();
                    this.updateProgress();
                    
                    // æ›´æ–°è°æ³¢æ¬¡æ•°
                    this.animationProgress += this.animationSpeed * 0.02;
                    if (this.animationProgress >= 1) {
                        this.animationProgress = 0;
                        this.currentHarmonic++;
                        
                        if (this.currentHarmonic > this.maxHarmonic) {
                            this.currentHarmonic = 1; // å¾ªç¯
                        }
                    }
                    
                    this.animationId = requestAnimationFrame(animate);
                };
                
                animate();
            }
            
            // æš‚åœåŠ¨ç”»
            pauseAnimation() {
                this.isAnimating = false;
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
                this.draw();
            }
            
            // é‡ç½®
            reset() {
                this.pauseAnimation();
                this.currentHarmonic = 1;
                this.animationProgress = 0;
                this.draw();
                this.updateInfo();
            }
        }
        
        // åˆå§‹åŒ–
        const visualizer = new FourierSeriesVisualizer('fourierCanvas');
        
        // æ·»åŠ é”®ç›˜æ§åˆ¶
        document.addEventListener('keydown', (e) => {
            switch (e.key) {
                case ' ':
                    e.preventDefault();
                    if (visualizer.isAnimating) {
                        visualizer.pauseAnimation();
                    } else {
                        visualizer.startAnimation();
                    }
                    break;
                case 'r':
                case 'R':
                    visualizer.reset();
                    break;
            }
        });
        
        // æ·»åŠ è§¦æ‘¸æ”¯æŒ
        let touchStartX = 0;
        const canvas = document.getElementById('fourierCanvas');
        
        canvas.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
        });
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const touchX = e.touches[0].clientX;
            const deltaX = touchX - touchStartX;
            
            if (Math.abs(deltaX) > 10) {
                const slider = document.getElementById('harmonicSlider');
                const currentValue = parseInt(slider.value);
                const newValue = deltaX > 0 ? 
                    Math.min(currentValue + 1, 30) : 
                    Math.max(currentValue - 1, 1);
                
                slider.value = newValue;
                slider.dispatchEvent(new Event('input'));
                touchStartX = touchX;
            }
        });
        
        // æ·»åŠ åŠ è½½å®Œæˆæç¤º
        window.addEventListener('load', () => {
            setTimeout(() => {
                const subtitle = document.querySelector('.subtitle');
                subtitle.innerHTML = 'ç‚¹å‡»æ’­æ”¾æŒ‰é’®æˆ–æŒ‰ç©ºæ ¼é”®å¼€å§‹åŠ¨ç”» â€¢ å·¦å³æ»‘åŠ¨è°ƒæ•´è°æ³¢æ¬¡æ•°';
                subtitle.classList.add('pulse');
            }, 1000);
        });
    </script>
</body>
</html>